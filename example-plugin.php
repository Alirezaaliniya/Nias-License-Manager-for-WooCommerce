<?php
/**
 * Plugin Name: ุงูุฒููู ููููู ูู
 * Plugin URI: https://yoursite.com/my-plugin
 * Description: ุงูุฒููู ููููู ุจุฑุง ููุงุด ฺฉูพุงุฑฺฺฏ ุจุง ุณุณุชู ูุฏุฑุช ูุงุณูุณ NLMW
 * Version: 1.0.0
 * Author: ูุงู ุดูุง
 * Author URI: https://yoursite.com
 * License: GPL-2.0+
 * Text Domain: my-plugin
 * Domain Path: /languages
 */

// ุฎุฑูุฌ ุฏุฑ ุตูุฑุช ุฏุณุชุฑุณ ูุณุชูู
if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

/**
 * ================================================================
 * ๐ฏ ุจุฎุด ููุฏุงุฑุฏู ุงููู - ุชูุธูุงุช ุงุตู ุงูุฒููู
 * ================================================================
 * 
 * โ๏ธ ููู: ุชูุงู ุชูุธูุงุช ุงูุฒููู ุฎูุฏ ุฑุง ููุท ุฏุฑ ุงู ุจุฎุด ุชุบุฑ ุฏูุฏ
 * 
 * ุงู ุจุฎุด ุดุงูู ุณู ูุณูุช ุงุตู ุงุณุช:
 * 
 * 1๏ธโฃ ุชูุธูุงุช ุงูุฒููู (PLUGIN_CONFIG):
 *    - 'prefix': ูพุดููุฏ ฺฉุชุง ุจุฑุง ุงูุฒููู ุดูุง (ููุท ุญุฑูู ฺฉูฺฺฉ ู ุฎุท ุชุฑู)
 *      ูุซุงู: 'my-shop', 'booking-system', 'crm-plugin'
 *      ุงู ูพุดููุฏ ุฏุฑ ุชูุงู ุฌุงูุง ุงุณุชูุงุฏู ูโุดูุฏ: ุซุงุจุชโูุงุ ุฏุชุงุจุณุ ฺฉุฑููโูุง
 * 
 *    - 'name': ูุงู ููุงุด ุงูุฒููู ุจู ูุงุฑุณ
 *      ูุซุงู: 'ุงูุฒููู ูุฑูุดฺฏุงู ูู', 'ุณุณุชู ุฑุฒุฑู', 'ูุฏุฑุช ุงุฑุชุจุงุท ุจุง ูุดุชุฑ'
 * 
 *    - 'text_domain': ุฏุงููู ูุชู ุจุฑุง ุชุฑุฌููโูุง (ูุนูููุงู ููุงู prefix)
 *      ุงู ููุฏุงุฑ ุจุงุฏ ุจุง Text Domain ุฏุฑ ูุฏุฑ ูุงู ฺฉุณุงู ุจุงุดุฏ
 * 
 * 2๏ธโฃ ุชูุธูุงุช ูุฑูุดฺฏุงู (STORE_CONFIG):
 *    - 'url': ุขุฏุฑุณ ฺฉุงูู ูุฑูุดฺฏุงู ููฺฉุงูุฑุณ ุดูุง
 *      ูุซุงู: 'https://mystore.com' ุง 'https://shop.example.ir'
 * 
 *    - 'consumer_key': ฺฉูุฏ API ููฺฉุงูุฑุณ (ุงุฒ ุชูุธูุงุช > ูพุดุฑูุชู > REST API)
 *      ุดุฑูุน ูโุดูุฏ ุจุง: ck_
 * 
 *    - 'consumer_secret': ุฑูุฒ API ููฺฉุงูุฑุณ
 *      ุดุฑูุน ูโุดูุฏ ุจุง: cs_
 * 
 * 3๏ธโฃ ุชูุธูุงุช ูุงุณูุณ (LICENSE_CONFIG):
 *    - 'product_ids': ุขุฑุงูโุง ุงุฒ ุดูุงุณู ูุญุตููุงุช ูุนุชุจุฑ ุฏุฑ ููฺฉุงูุฑุณ
 *      ูุซุงู: array( 123, 456 ) - ููุท ุงู ูุญุตููุงุช ูุงุณูุณ ูุนุชุจุฑ ูุณุชูุฏ
 *      ุจุฑุง ูุจูู ููู ูุญุตููุงุช: array() ุง ุจฺฏุฐุงุฑุฏ ุฎุงู
 * 
 *    - 'cache_days': ุชุนุฏุงุฏ ุฑูุฒูุง ฺฉู ูุชุฌู ุจุฑุฑุณ ูุงุณูุณ ฺฉุด ูโุดูุฏ
 *      ูุซุงู: 5 = ูุฑ 5 ุฑูุฒ ฺฉุจุงุฑ ุจุฑุฑุณ ูโุดูุฏ
 *      ุชูุตู: ุจู 3 ุชุง 7 ุฑูุฒ
 * 
 * ๐ก ูฺฉุงุช ููู:
 * - ูพุณ ุงุฒ ุชุบุฑ 'prefix'ุ ุงูุฒููู ุฑุง ุบุฑูุนุงู ู ูุฌุฏุฏุงู ูุนุงู ฺฉูุฏ
 * - ุงุฒ prefix ฺฉุชุง ุงุณุชูุงุฏู ฺฉูุฏ ุชุง ุจุง ุงูุฒูููโูุง ุฏฺฏุฑ ุชุฏุงุฎู ูุฏุงุดุชู ุจุงุดุฏ
 * - ฺฉูุฏูุง API ุฑุง ุงุฒ ุจุฎุด ููฺฉุงูุฑุณ > ุชูุธูุงุช > ูพุดุฑูุชู > REST API ุฏุฑุงูุช ฺฉูุฏ
 * - ููฺฏุงู ุงุฌุงุฏ ฺฉูุฏ APIุ ุฏุณุชุฑุณ "ุฎูุงูุฏู" ฺฉุงู ุงุณุช
 * 
 * ================================================================
 */

// 1๏ธโฃ ุชูุธูุงุช ุงูุฒููู
$PLUGIN_CONFIG = array(
    // ูพุดููุฏ ฺฉุชุง - ุงู ููุฏุงุฑ ุฏุฑ ููู ุฌุง ุงุณุชูุงุฏู ูโุดูุฏ (ุซุงุจุชโูุงุ ุฏุชุงุจุณุ ฺฉุฑููโูุง)
    // ููุท ุงุฒ ุญุฑูู ฺฉูฺฺฉ ุงูฺฏูุณ ู ุฎุท ุชุฑู ุงุณุชูุงุฏู ฺฉูุฏ
    // ูุซุงู: 'my-shop', 'booking-plugin', 'crm-system'
    'prefix'        => 'my-plugin',
    
    // ูุงู ููุงุด ุงูุฒููู - ุงู ูุงู ุฏุฑ ุตูุญุงุช ูุฏุฑุช ููุงุด ุฏุงุฏู ูโุดูุฏ
    'name'          => 'ุงูุฒููู ููููู ูู',
    
    // ุฏุงููู ูุชู ุจุฑุง ุชุฑุฌููโูุง - ูุนูููุงู ููุงู prefix
    'text_domain'   => 'my-plugin',
);

// 2๏ธโฃ ุชูุธูุงุช ูุฑูุดฺฏุงู ููฺฉุงูุฑุณ
$STORE_CONFIG = array(
    // ุขุฏุฑุณ ฺฉุงูู ูุฑูุดฺฏุงู (ุจุฏูู / ุฏุฑ ุงูุชูุง)
    'url'              => 'https://example.com',
    
    // ฺฉูุฏ ูุตุฑูโฺฉููุฏู API (Consumer Key) - ุงุฒ ุชูุธูุงุช ููฺฉุงูุฑุณ ุฏุฑุงูุช ฺฉูุฏ
    'consumer_key'     => 'ck_test1234567890abcdef',
    
    // ุฑูุฒ ูุตุฑูโฺฉููุฏู API (Consumer Secret) - ุงุฒ ุชูุธูุงุช ููฺฉุงูุฑุณ ุฏุฑุงูุช ฺฉูุฏ
    'consumer_secret'  => 'cs_test1234567890abcdef',
);

// 3๏ธโฃ ุชูุธูุงุช ูุงุณูุณ
$LICENSE_CONFIG = array(
    // ุดูุงุณู ูุญุตููุงุช ูุนุชุจุฑ ุฏุฑ ููฺฉุงูุฑุณ (Product IDs)
    // ูุซุงู: array( 123, 456, 789 )
    // ุจุฑุง ูุจูู ููู ูุญุตููุงุช: array() ุจฺฏุฐุงุฑุฏ
    'product_ids'  => array( 5735, 5736, 5737 ),
    
    // ุชุนุฏุงุฏ ุฑูุฒูุง ฺฉุด ุจุฑุฑุณ ูุงุณูุณ (ุจู 3 ุชุง 7 ุฑูุฒ ุชูุตู ูโุดูุฏ)
    'cache_days'   => 5,
);

/**
 * ================================================================
 * โ๏ธ ุชูุธูุงุช ุฎูุฏฺฉุงุฑ - ุงู ุจุฎุด ุฑุง ุชุบุฑ ูุฏูุฏ
 * ================================================================
 * ุงู ุจุฎุด ุจุฑ ุงุณุงุณ ุชูุธูุงุช ุจุงูุงุ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ููุงุฏุฑ ุฑุง ุชูุธู ูโฺฉูุฏ
 */

// ุงุณุชุฎุฑุงุฌ ูพุดููุฏ ุงุฒ ุชูุธูุงุช
$PREFIX = $PLUGIN_CONFIG['prefix'];

// ุชุจุฏู ูพุดููุฏ ุจู ุญุฑูู ุจุฒุฑฺฏ ุจุฑุง ุซุงุจุชโูุง (my-plugin => MY_PLUGIN)
$CONST_PREFIX = strtoupper( str_replace( '-', '_', $PREFIX ) );

// ุชุนุฑู ุซุงุจุชโูุง ุงูุฒููู ุจุง ูพุดููุฏ ุฏุงูุงูฺฉ
define( $CONST_PREFIX . '_VERSION', '1.0.0' );
define( $CONST_PREFIX . '_PATH', plugin_dir_path( __FILE__ ) );
define( $CONST_PREFIX . '_URL', plugin_dir_url( __FILE__ ) );
define( $CONST_PREFIX . '_BASENAME', plugin_basename( __FILE__ ) );

// ูุชุบุฑ ุณุฑุงุณุฑ ุจุฑุง ุฐุฎุฑู ูุถุนุช ูุงุณูุณ
// ูุงู ูุชุบุฑ ุจุฑ ุงุณุงุณ ูพุดููุฏ ุณุงุฎุชู ูโุดูุฏ
$GLOBALS[ $PREFIX . '_license_valid' ] = false;

// ================================================================

/**
 * ================================================================
 * ๐ฆ ุจุงุฑฺฏุฐุงุฑ ูุงูโูุง ฺฉุชุงุจุฎุงูู NLMW
 * ================================================================
 */
$plugin_path = constant( $CONST_PREFIX . '_PATH' );
require_once $plugin_path . 'includes/license/class-license-manager-client.php';
require_once $plugin_path . 'includes/license/class-license-settings-page.php';
require_once $plugin_path . 'includes/license/class-license-cron-handler.php';

/**
 * ================================================================
 * ๐ ุฑุงูโุงูุฏุงุฒ ุงูุฒููู
 * ================================================================
 * ุงู ุชุงุจุน ุฏุฑ ููฺฉ plugins_loaded ุงุฌุฑุง ูโุดูุฏ ู ุชูุงู ุงุฌุฒุง ุงูุฒููู ุฑุง ููุฏุงุฑุฏู ูโฺฉูุฏ
 */
add_action( 'plugins_loaded', function() {
    global $PLUGIN_CONFIG, $STORE_CONFIG, $LICENSE_CONFIG, $PREFIX, $CONST_PREFIX;
    
    // ุงุณุชุฎุฑุงุฌ ุชูุธูุงุช
    $plugin_name = $PLUGIN_CONFIG['name'];
    $plugin_slug = $PREFIX;  // ุงุณุชูุงุฏู ุงุฒ ูพุดููุฏ ุจู ุนููุงู slug
    $text_domain = $PLUGIN_CONFIG['text_domain'];
    
    // ุชุฑฺฉุจ ุชูุธูุงุช API
    $API_CONFIG = array_merge( $STORE_CONFIG, array( 'product_ids' => $LICENSE_CONFIG['product_ids'] ) );
    
    /**
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * 1๏ธโฃ ุฑุงูโุงูุฏุงุฒ ุตูุญู ุชูุธูุงุช ูุงุณูุณ
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * ุงู ฺฉูุงุณ ุตูุญู ุชูุธูุงุช ุฑุง ุฏุฑ ูพูู ูุฏุฑุช ุงุฌุงุฏ ูโฺฉูุฏ
     * ูุณุฑ: ุชูุธูุงุช > ูุงุณูุณ [ูุงู ุงูุฒููู]
     */
    new Nias_License_Settings_Page(
        $plugin_name,      // ูุงู ููุงุด ุงูุฒููู
        $plugin_slug,      // ุดูุงุณู ฺฉุชุง (ุจุฑุง ุฐุฎุฑู ุฏุฑ ุฏุชุงุจุณ)
        $plugin_slug,      // ุดูุงุณู ุงูุฒููู (ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุชุฏุงุฎู)
        $API_CONFIG        // ุชูุธูุงุช ุงุชุตุงู ุจู ูุฑูุดฺฏุงู
    );
    
    /**
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * 2๏ธโฃ ุฑุงูโุงูุฏุงุฒ ุจุฑุฑุณ ุฎูุฏฺฉุงุฑ ูุงุณูุณ (Cron Job)
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * ุงู ฺฉูุงุณ ูุฑ ุฑูุฒ ฺฉุจุงุฑ ูุงุณูุณ ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ
     * ุฒูุงู ุจุฑุฑุณ: ูุฑ 24 ุณุงุนุช (DAY_IN_SECONDS)
     */
    new Nias_License_Cron_Handler(
        $plugin_slug,      // ุดูุงุณู ฺฉุชุง ุจุฑุง ูุงู ฺฉุฑูู
        DAY_IN_SECONDS,    // ูุงุตูู ุฒูุงู ุจุฑุฑุณ (24 ุณุงุนุช)
        $plugin_slug       // ุดูุงุณู ุงูุฒููู
    );
    
    /**
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * 3๏ธโฃ ุฑุงูโุงูุฏุงุฒ ฺฉูุงูุช ูุฏุฑุช ูุงุณูุณ
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * ุงู ฺฉูุงุณ ุจุง ูุฑูุดฺฏุงู ููฺฉุงูุฑุณ ุงุฑุชุจุงุท ุจุฑูุฑุงุฑ ูโฺฉูุฏ
     * ู ุงุนุชุจุงุฑ ูุงุณูุณ ุฑุง ุจุฑุฑุณ ูโฺฉูุฏ
     */
    $license_client = new Nias_License_Manager_Client(
        $STORE_CONFIG['url'],              // ุขุฏุฑุณ ูุฑูุดฺฏุงู
        $STORE_CONFIG['consumer_key'],     // ฺฉูุฏ API
        $STORE_CONFIG['consumer_secret'],  // ุฑูุฒ API
        $LICENSE_CONFIG['product_ids'],    // ูุญุตููุงุช ูุนุชุจุฑ
        $LICENSE_CONFIG['cache_days'],     // ูุฏุช ฺฉุด
        $plugin_slug                        // ุดูุงุณู ุงูุฒููู
    );
    
    /**
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * 4๏ธโฃ ุจุฑุฑุณ ูุถุนุช ูุงุณูุณ
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * ฺฉูุฏ ูุงุณูุณ ุงุฒ ุฏุชุงุจุณ ุฎูุงูุฏู ุดุฏู ู ุงุนุชุจุงุฑ ุขู ุจุฑุฑุณ ูโุดูุฏ
     */
    $license_key = get_option( 'nlmw_' . $plugin_slug . '_license_key', '' );
    
    if ( ! empty( $license_key ) && $license_client->nias_is_license_valid( $license_key ) ) {
        // โ ูุงุณูุณ ูุนุชุจุฑ ุงุณุช
        $GLOBALS[ $PREFIX . '_license_valid' ] = true;
        
        // ุงูุฌุง ูโุชูุงูุฏ ูฺฺฏโูุง ุงูุฒููู ุฑุง ูุนุงู ฺฉูุฏ
        // ูุซุงู: add_action( 'init', 'my_plugin_init_features' );
        
    } else {
        // โ ูุงุณูุณ ูุงูุนุชุจุฑ ุง ูุงุฑุฏ ูุดุฏู ุงุณุช
        $GLOBALS[ $PREFIX . '_license_valid' ] = false;
        
        // ููุงุด ูพุงู ูุดุฏุงุฑ ุฏุฑ ูพูู ูุฏุฑุช
        add_action( 'admin_notices', function() use ( $plugin_name, $plugin_slug, $text_domain ) {
            ?>
            <div class="notice notice-warning is-dismissible">
                <p>
                    <strong><?php echo esc_html( $plugin_name ); ?>:</strong>
                    <?php 
                    printf(
                        'ูุทูุงู ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุชูุงู ุงูฺฉุงูุงุชุ <a href="%s">ูุงุณูุณ ุฎูุฏ ุฑุง ูุนุงู ฺฉูุฏ</a>.',
                        esc_url( admin_url( 'options-general.php?page=' . $plugin_slug . '-license' ) )
                    );
                    ?>
                </p>
            </div>
            <?php
        });
    }
    
    /**
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * 5๏ธโฃ ุจุงุฑฺฏุฐุงุฑ ูุงูโูุง ุชุฑุฌูู
     * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     * ูุงูโูุง ุชุฑุฌูู ุงุฒ ูพูุดู /languages ุจุงุฑฺฏุฐุงุฑ ูโุดููุฏ
     */
    $plugin_basename = constant( $CONST_PREFIX . '_BASENAME' );
    load_plugin_textdomain(
        $text_domain,
        false,
        dirname( $plugin_basename ) . '/languages'
    );
} );

/**
 * ================================================================
 * โก ููฺฉ ูุนุงูโุณุงุฒ ุงูุฒููู
 * ================================================================
 * ุงู ุชุงุจุน ููฺฏุงู ูุนุงูโุณุงุฒ ุงูุฒููู ุงุฌุฑุง ูโุดูุฏ
 * ุจุฑุง ุชูุธูุงุช ุงููู ู ุงุฌุงุฏ ุฌุฏุงูู ุฏุชุงุจุณ ุงุณุชูุงุฏู ูโุดูุฏ
 */
register_activation_hook( __FILE__, function() {
    global $PREFIX, $CONST_PREFIX;
    
    // ุฐุฎุฑู ุฒูุงู ูุนุงูโุณุงุฒ
    add_option( $PREFIX . '_activation_time', current_time( 'mysql' ) );
    
    // ุฐุฎุฑู ูุณุฎู ุงูุฒููู
    $version = constant( $CONST_PREFIX . '_VERSION' );
    add_option( $PREFIX . '_version', $version );
    
    // ุจุงุฒููุณ ููุงูู URL ุฏุฑ ุตูุฑุช ูุงุฒ
    // ุงฺฏุฑ ุงูุฒููู ุดูุง ุงุฒ Custom Post Type ุง Rewrite Rules ุงุณุชูุงุฏู ูโฺฉูุฏ
    flush_rewrite_rules();
    
    // ุซุจุช ูุงฺฏ ูุนุงูโุณุงุฒ
    error_log( sprintf(
        '[%s] ุงูุฒููู ุฏุฑ ุชุงุฑุฎ %s ูุนุงู ุดุฏ',
        $PREFIX,
        current_time( 'mysql' )
    ) );
});

/**
 * ================================================================
 * ๐ ููฺฉ ุบุฑูุนุงูโุณุงุฒ ุงูุฒููู
 * ================================================================
 * ุงู ุชุงุจุน ููฺฏุงู ุบุฑูุนุงูโุณุงุฒ ุงูุฒููู ุงุฌุฑุง ูโุดูุฏ
 * ุจุฑุง ูพุงฺฉุณุงุฒ ฺฉุฑููโูุง ู ุชูุธูุงุช ูููุช ุงุณุชูุงุฏู ูโุดูุฏ
 */
register_deactivation_hook( __FILE__, function() {
    global $PREFIX;
    
    // ูพุงฺฉ ฺฉุฑุฏู ฺฉุฑูู ุจุฑุฑุณ ุฎูุฏฺฉุงุฑ ูุงุณูุณ
    wp_clear_scheduled_hook( 'nlmw_' . $PREFIX . '_license_check' );
    
    // ุจุงุฒููุณ ููุงูู URL
    flush_rewrite_rules();
    
    // ุซุจุช ูุงฺฏ ุบุฑูุนุงูโุณุงุฒ
    error_log( sprintf(
        '[%s] ุงูุฒููู ุฏุฑ ุชุงุฑุฎ %s ุบุฑูุนุงู ุดุฏ',
        $PREFIX,
        current_time( 'mysql' )
    ) );
});

/**
 * ================================================================
 * ๐ ุชูุงุจุน ฺฉูฺฉ ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ุงูุฒููู
 * ================================================================
 */

/**
 * ุจุฑุฑุณ ุงูฺฉู ุขุง ูุงุณูุณ ูุนุชุจุฑ ุงุณุช ุง ุฎุฑ
 * 
 * @return bool true ุงฺฏุฑ ูุงุณูุณ ูุนุชุจุฑ ุจุงุดุฏุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช false
 * 
 * ูุซุงู ุงุณุชูุงุฏู:
 * if ( license_valid() ) {
 *     // ูฺฺฏ ูพุฑููู ุฑุง ูุนุงู ฺฉู
 * } else {
 *     // ูพุงู ูุญุฏูุฏุช ููุงุด ุจุฏู
 * }
 */
function license_valid() {
    global $PREFIX;
    return isset( $GLOBALS[ $PREFIX . '_license_valid' ] ) && $GLOBALS[ $PREFIX . '_license_valid' ] === true;
}

/**
 * ุฏุฑุงูุช ูุณุฑ ุงูุฒููู
 * 
 * @return string ูุณุฑ ฺฉุงูู ูพูุดู ุงูุฒููู
 */
function get_plugin_path() {
    global $CONST_PREFIX;
    return constant( $CONST_PREFIX . '_PATH' );
}

/**
 * ุฏุฑุงูุช URL ุงูุฒููู
 * 
 * @return string ุขุฏุฑุณ URL ูพูุดู ุงูุฒููู
 */
function get_plugin_url() {
    global $CONST_PREFIX;
    return constant( $CONST_PREFIX . '_URL' );
}

/**
 * ุฏุฑุงูุช ูุณุฎู ุงูุฒููู
 * 
 * @return string ุดูุงุฑู ูุณุฎู
 */
function get_plugin_version() {
    global $CONST_PREFIX;
    return constant( $CONST_PREFIX . '_VERSION' );
}
